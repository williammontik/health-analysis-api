# -*- coding: utf-8 -*-
import os, random, logging, smtplib
from datetime import datetime
from dateutil import parser
from email.mime.text import MIMEText
from flask import Flask, request, jsonify
from flask_cors import CORS
from openai import OpenAI

app = Flask(__name__)
CORS(app)
logging.basicConfig(level=logging.DEBUG)

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
SMTP_USERNAME = "kata.chatbot@gmail.com"
SMTP_PASSWORD = os.getenv("SMTP_PASSWORD")

LANGUAGE = {
    "en": {
        "email_subject": "Your Health Insight Report",
        "report_title": "🎉 Global Identical Health Insights",
        "creative_title": "💡 Creative Support Ideas",
        "footer": (
            '<div style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>The insights in this report are generated by KataChat’s AI systems analyzing:</strong><br>'
            '1. Our proprietary database of anonymized medical profiles across Singapore, Malaysia, and Taiwan<br>'
            '2. Aggregated global health benchmarks from trusted OpenAI research and medical reports trend datasets<br>'
            '<em>All data is processed through our AI models to identify statistically significant patterns while maintaining strict PDPA compliance. '
            'Sample sizes vary by analysis, with minimum thresholds of 700+ data points for medical comparisons.</em>'
            '</div>'
            '<p style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>PS:</strong> This report has also been sent to your email inbox and should arrive within 24 hours. '
            'If you\'d like to discuss it further, feel free to reach out — we’re happy to arrange a 15-minute call at your convenience.</p>'
        )
    },
    "zh": {
        "email_subject": "您的健康洞察報告",
        "report_title": "🎉 全球健康洞察（简体）",
        "creative_title": "💡 创意健康建议",
        "footer": (
            '<div style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>本報告的洞察來自 KataChat AI 系統的分析：</strong><br>'
            '1. 我們在新加坡、馬來西亞與台灣的匿名健康檔案資料庫<br>'
            '2. 結合全球可信賴的健康趨勢與醫療報告資料集<br>'
            '<em>所有資料皆由 AI 模型處理，找出具統計顯著性的健康趨勢，同時嚴格遵守 PDPA 數據保護法。</em>'
            '</div>'
            '<p style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>附註：</strong>此報告已發送到您的電子郵件信箱，請於24小時內查收。若您想進一步諮詢，歡迎聯繫我們預約15分鐘通話。</p>'
        )
    },
    "tw": {
        "email_subject": "您的健康洞察報告",
        "report_title": "🎉 全球健康洞察（繁體）",
        "creative_title": "💡 創意健康建議",
        "footer": (
            '<div style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>本報告的洞察是由 KataChat 的 AI 系統分析得出：</strong><br>'
            '1. 我們於新加坡、馬來西亞和台灣所建立的匿名健康資料庫<br>'
            '2. 結合 OpenAI 醫療研究與全球趨勢數據進行統計分析<br>'
            '<em>所有資料皆透過 AI 處理，嚴格遵守 PDPA 法規，樣本數皆超過 700 筆。</em>'
            '</div>'
            '<p style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>備註：</strong>報告已寄出至您的電子信箱，如需進一步討論，歡迎安排15分鐘線上會談。</p>'
        )
    }
}

def send_email(html_body, lang):
    subject = LANGUAGE.get(lang, LANGUAGE["en"])["email_subject"]
    msg = MIMEText(html_body, 'html', 'utf-8')
    msg['Subject'] = subject
    msg['From'] = SMTP_USERNAME
    msg['To'] = SMTP_USERNAME
    try:
        with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
            server.starttls()
            server.login(SMTP_USERNAME, SMTP_PASSWORD)
            server.send_message(msg)
    except Exception as e:
        app.logger.error(f"Email send error: {e}")

# (rest of the script continues with prompt language appending + footer localization + creative_title usage)
