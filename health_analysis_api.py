# -*- coding: utf-8 -*-
import os, random, logging, smtplib
from datetime import datetime
from dateutil import parser
from email.mime.text import MIMEText
from flask import Flask, request, jsonify
from flask_cors import CORS
from openai import OpenAI

app = Flask(__name__)
CORS(app)
logging.basicConfig(level=logging.DEBUG)

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
SMTP_USERNAME = "kata.chatbot@gmail.com"
SMTP_PASSWORD = os.getenv("SMTP_PASSWORD")

LANGUAGE = {
    "en": {
        "email_subject": "Your Health Insight Report",
        "report_title": "ğŸ‰ Global Identical Health Insights",
        "creative_title": "ğŸ’¡ Creative Support Ideas",
        "footer": (
            '<div style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>The insights in this report are generated by KataChatâ€™s AI systems analyzing:</strong><br>'
            '1. Our proprietary database of anonymized medical profiles across Singapore, Malaysia, and Taiwan<br>'
            '2. Aggregated global health benchmarks from trusted OpenAI research and medical reports trend datasets<br>'
            '<em>All data is processed through our AI models to identify statistically significant patterns while maintaining strict PDPA compliance. '
            'Sample sizes vary by analysis, with minimum thresholds of 700+ data points for medical comparisons.</em>'
            '</div>'
            '<p style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>PS:</strong> This report has also been sent to your email inbox and should arrive within 24 hours. '
            'If you\'d like to discuss it further, feel free to reach out â€” weâ€™re happy to arrange a 15-minute call at your convenience.</p>'
        )
    },
    "zh": {
        "email_subject": "æ‚¨çš„å¥åº·æ´å¯Ÿå ±å‘Š",
        "report_title": "ğŸ‰ å…¨çƒå¥åº·æ´å¯Ÿï¼ˆç®€ä½“ï¼‰",
        "creative_title": "ğŸ’¡ åˆ›æ„å¥åº·å»ºè®®",
        "footer": (
            '<div style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>æœ¬å ±å‘Šçš„æ´å¯Ÿä¾†è‡ª KataChat AI ç³»çµ±çš„åˆ†æï¼š</strong><br>'
            '1. æˆ‘å€‘åœ¨æ–°åŠ å¡ã€é¦¬ä¾†è¥¿äºèˆ‡å°ç£çš„åŒ¿åå¥åº·æª”æ¡ˆè³‡æ–™åº«<br>'
            '2. çµåˆå…¨çƒå¯ä¿¡è³´çš„å¥åº·è¶¨å‹¢èˆ‡é†«ç™‚å ±å‘Šè³‡æ–™é›†<br>'
            '<em>æ‰€æœ‰è³‡æ–™çš†ç”± AI æ¨¡å‹è™•ç†ï¼Œæ‰¾å‡ºå…·çµ±è¨ˆé¡¯è‘—æ€§çš„å¥åº·è¶¨å‹¢ï¼ŒåŒæ™‚åš´æ ¼éµå®ˆ PDPA æ•¸æ“šä¿è­·æ³•ã€‚</em>'
            '</div>'
            '<p style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>é™„è¨»ï¼š</strong>æ­¤å ±å‘Šå·²ç™¼é€åˆ°æ‚¨çš„é›»å­éƒµä»¶ä¿¡ç®±ï¼Œè«‹æ–¼24å°æ™‚å…§æŸ¥æ”¶ã€‚è‹¥æ‚¨æƒ³é€²ä¸€æ­¥è«®è©¢ï¼Œæ­¡è¿è¯ç¹«æˆ‘å€‘é ç´„15åˆ†é˜é€šè©±ã€‚</p>'
        )
    },
    "tw": {
        "email_subject": "æ‚¨çš„å¥åº·æ´å¯Ÿå ±å‘Š",
        "report_title": "ğŸ‰ å…¨çƒå¥åº·æ´å¯Ÿï¼ˆç¹é«”ï¼‰",
        "creative_title": "ğŸ’¡ å‰µæ„å¥åº·å»ºè­°",
        "footer": (
            '<div style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>æœ¬å ±å‘Šçš„æ´å¯Ÿæ˜¯ç”± KataChat çš„ AI ç³»çµ±åˆ†æå¾—å‡ºï¼š</strong><br>'
            '1. æˆ‘å€‘æ–¼æ–°åŠ å¡ã€é¦¬ä¾†è¥¿äºå’Œå°ç£æ‰€å»ºç«‹çš„åŒ¿åå¥åº·è³‡æ–™åº«<br>'
            '2. çµåˆ OpenAI é†«ç™‚ç ”ç©¶èˆ‡å…¨çƒè¶¨å‹¢æ•¸æ“šé€²è¡Œçµ±è¨ˆåˆ†æ<br>'
            '<em>æ‰€æœ‰è³‡æ–™çš†é€é AI è™•ç†ï¼Œåš´æ ¼éµå®ˆ PDPA æ³•è¦ï¼Œæ¨£æœ¬æ•¸çš†è¶…é 700 ç­†ã€‚</em>'
            '</div>'
            '<p style="background-color:#e6f7ff; color:#00529B; padding:15px; '
            'border-left:4px solid #00529B; margin:20px 0;">'
            '<strong>å‚™è¨»ï¼š</strong>å ±å‘Šå·²å¯„å‡ºè‡³æ‚¨çš„é›»å­ä¿¡ç®±ï¼Œå¦‚éœ€é€²ä¸€æ­¥è¨è«–ï¼Œæ­¡è¿å®‰æ’15åˆ†é˜ç·šä¸Šæœƒè«‡ã€‚</p>'
        )
    }
}

def send_email(html_body, lang):
    subject = LANGUAGE.get(lang, LANGUAGE["en"])["email_subject"]
    msg = MIMEText(html_body, 'html', 'utf-8')
    msg['Subject'] = subject
    msg['From'] = SMTP_USERNAME
    msg['To'] = SMTP_USERNAME
    try:
        with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
            server.starttls()
            server.login(SMTP_USERNAME, SMTP_PASSWORD)
            server.send_message(msg)
    except Exception as e:
        app.logger.error(f"Email send error: {e}")

# (rest of the script continues with prompt language appending + footer localization + creative_title usage)
